#include <cstdio>
#include <iostream>
#include <cstdint>
#include <vector>
#include <array>
#include <utility>
#include <bitset>
//#include "GEMAMC13EventFormat.h"
#include <TFile.h>
#include <TTree.h>
#include <TH2F.h>

#include "TestBeamMapping.h"
#include "GEMAMCEventFormat.h"


// int to_chamber[4][12] = {
//     {-1, -1, -1, -1, -2, -1, -2, -1, -2, -2, -2, -2},
//     {-3, -3, -3, -3, -4, -3, -4, -3, -4, -4, -4, -4},
//     {1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0},
//     {3, 3, 3, 3, 2, 3, 2, 3, 2, 2, 2, 2}
// };
// int to_strip[12][128] = {
//     {147, 146, 148, 149, 145, 144, 150, 151, 143, 142, 152, 153, 141, 140, 154, 155, 139, 138, 156, 157, 137, 136, 158, 159, 135, 134, 160, 161, 133, 132, 163, 162, 131, 130, 164, 165, 129, 128, 166, 167, 127, 126, 168, 169, 125, 124, 170, 171, 123, 49, 172, 173, 52, 53, 174, 175, 56, 57, 176, 177, 60, 61, 178, 179, 64, 65, 180, 181, 68, 69, 182, 183, 72, 73, 184, 185, 76, 236, 186, 187, 235, 234, 188, 189, 233, 232, 190, 191, 231, 230, 192, 193, 229, 228, 194, 195, 227, 226, 196, 197, 225, 224, 198, 199, 223, 222, 200, 201, 221, 220, 203, 202, 219, 218, 205, 204, 217, 216, 207, 206, 215, 214, 209, 208, 213, 212, 211, 210},
//     {262, 261, 263, 264, 260, 259, 265, 266, 258, 257, 267, 268, 256, 255, 269, 270, 254, 253, 271, 272, 252, 251, 273, 274, 250, 249, 275, 276, 248, 247, 278, 277, 246, 245, 279, 280, 244, 243, 281, 282, 242, 241, 283, 284, 240, 239, 285, 286, 238, 237, 287, 288, 52, 53, 289, 290, 56, 57, 291, 292, 60, 61, 293, 294, 358, 357, 295, 296, 356, 355, 297, 298, 354, 353, 299, 300, 352, 351, 301, 302, 350, 349, 303, 304, 348, 347, 305, 306, 346, 345, 307, 308, 344, 343, 309, 310, 342, 341, 311, 312, 340, 339, 313, 314, 338, 337, 315, 316, 336, 335, 318, 317, 334, 333, 320, 319, 332, 331, 322, 321, 330, 329, 324, 323, 328, 327, 326, 325},
//     {32, 31, 33, 34, 30, 29, 35, 36, 28, 27, 37, 38, 26, 25, 39, 40, 24, 23, 41, 42, 22, 21, 43, 44, 20, 19, 45, 46, 18, 17, 48, 47, 16, 15, 49, 50, 14, 13, 51, 52, 12, 11, 53, 54, 10, 9, 55, 56, 8, 7, 57, 58, 6, 5, 59, 60, 4, 3, 61, 62, 2, 1, 63, 64, 64, 65, 65, 66, 68, 69, 67, 68, 72, 73, 69, 70, 122, 121, 71, 72, 120, 119, 73, 74, 118, 117, 75, 76, 116, 115, 77, 78, 114, 113, 79, 80, 112, 111, 81, 82, 110, 109, 83, 84, 108, 107, 85, 86, 106, 105, 88, 87, 104, 103, 90, 89, 102, 101, 92, 91, 100, 99, 94, 93, 98, 97, 96, 95},
//     {262, 261, 263, 264, 260, 259, 265, 266, 258, 257, 267, 268, 256, 255, 269, 270, 254, 253, 271, 272, 252, 251, 273, 274, 250, 249, 275, 276, 248, 247, 278, 277, 246, 245, 279, 280, 244, 243, 281, 282, 242, 241, 283, 284, 240, 239, 285, 286, 238, 237, 287, 288, 52, 53, 289, 290, 56, 57, 291, 292, 60, 61, 293, 294, 358, 357, 295, 296, 356, 355, 297, 298, 354, 353, 299, 300, 352, 351, 301, 302, 350, 349, 303, 304, 348, 347, 305, 306, 346, 345, 307, 308, 344, 343, 309, 310, 342, 341, 311, 312, 340, 339, 313, 314, 338, 337, 315, 316, 336, 335, 318, 317, 334, 333, 320, 319, 332, 331, 322, 321, 330, 329, 324, 323, 328, 327, 326, 325},
//     {32, 31, 33, 34, 30, 29, 35, 36, 28, 27, 37, 38, 26, 25, 39, 40, 24, 23, 41, 42, 22, 21, 43, 44, 20, 19, 45, 46, 18, 17, 48, 47, 16, 15, 49, 50, 14, 13, 51, 52, 12, 11, 53, 54, 10, 9, 55, 56, 8, 7, 57, 58, 6, 5, 59, 60, 4, 3, 61, 62, 2, 1, 63, 64, 64, 65, 65, 66, 68, 69, 67, 68, 72, 73, 69, 70, 122, 121, 71, 72, 120, 119, 73, 74, 118, 117, 75, 76, 116, 115, 77, 78, 114, 113, 79, 80, 112, 111, 81, 82, 110, 109, 83, 84, 108, 107, 85, 86, 106, 105, 88, 87, 104, 103, 90, 89, 102, 101, 92, 91, 100, 99, 94, 93, 98, 97, 96, 95},
//     {147, 146, 148, 149, 145, 144, 150, 151, 143, 142, 152, 153, 141, 140, 154, 155, 139, 138, 156, 157, 137, 136, 158, 159, 135, 134, 160, 161, 133, 132, 163, 162, 131, 130, 164, 165, 129, 128, 166, 167, 127, 126, 168, 169, 125, 124, 170, 171, 123, 49, 172, 173, 52, 53, 174, 175, 56, 57, 176, 177, 60, 61, 178, 179, 64, 65, 180, 181, 68, 69, 182, 183, 72, 73, 184, 185, 76, 236, 186, 187, 235, 234, 188, 189, 233, 232, 190, 191, 231, 230, 192, 193, 229, 228, 194, 195, 227, 226, 196, 197, 225, 224, 198, 199, 223, 222, 200, 201, 221, 220, 203, 202, 219, 218, 205, 204, 217, 216, 207, 206, 215, 214, 209, 208, 213, 212, 211, 210},
//     {147, 146, 148, 149, 145, 144, 150, 151, 143, 142, 152, 153, 141, 140, 154, 155, 139, 138, 156, 157, 137, 136, 158, 159, 135, 134, 160, 161, 133, 132, 163, 162, 131, 130, 164, 165, 129, 128, 166, 167, 127, 126, 168, 169, 125, 124, 170, 171, 123, 49, 172, 173, 52, 53, 174, 175, 56, 57, 176, 177, 60, 61, 178, 179, 64, 65, 180, 181, 68, 69, 182, 183, 72, 73, 184, 185, 76, 236, 186, 187, 235, 234, 188, 189, 233, 232, 190, 191, 231, 230, 192, 193, 229, 228, 194, 195, 227, 226, 196, 197, 225, 224, 198, 199, 223, 222, 200, 201, 221, 220, 203, 202, 219, 218, 205, 204, 217, 216, 207, 206, 215, 214, 209, 208, 213, 212, 211, 210},
//     {32, 31, 33, 34, 30, 29, 35, 36, 28, 27, 37, 38, 26, 25, 39, 40, 24, 23, 41, 42, 22, 21, 43, 44, 20, 19, 45, 46, 18, 17, 48, 47, 16, 15, 49, 50, 14, 13, 51, 52, 12, 11, 53, 54, 10, 9, 55, 56, 8, 7, 57, 58, 6, 5, 59, 60, 4, 3, 61, 62, 2, 1, 63, 64, 64, 65, 65, 66, 68, 69, 67, 68, 72, 73, 69, 70, 122, 121, 71, 72, 120, 119, 73, 74, 118, 117, 75, 76, 116, 115, 77, 78, 114, 113, 79, 80, 112, 111, 81, 82, 110, 109, 83, 84, 108, 107, 85, 86, 106, 105, 88, 87, 104, 103, 90, 89, 102, 101, 92, 91, 100, 99, 94, 93, 98, 97, 96, 95},
//     {262, 261, 263, 264, 260, 259, 265, 266, 258, 257, 267, 268, 256, 255, 269, 270, 254, 253, 271, 272, 252, 251, 273, 274, 250, 249, 275, 276, 248, 247, 278, 277, 246, 245, 279, 280, 244, 243, 281, 282, 242, 241, 283, 284, 240, 239, 285, 286, 238, 237, 287, 288, 52, 53, 289, 290, 56, 57, 291, 292, 60, 61, 293, 294, 358, 357, 295, 296, 356, 355, 297, 298, 354, 353, 299, 300, 352, 351, 301, 302, 350, 349, 303, 304, 348, 347, 305, 306, 346, 345, 307, 308, 344, 343, 309, 310, 342, 341, 311, 312, 340, 339, 313, 314, 338, 337, 315, 316, 336, 335, 318, 317, 334, 333, 320, 319, 332, 331, 322, 321, 330, 329, 324, 323, 328, 327, 326, 325},
//     {32, 31, 33, 34, 30, 29, 35, 36, 28, 27, 37, 38, 26, 25, 39, 40, 24, 23, 41, 42, 22, 21, 43, 44, 20, 19, 45, 46, 18, 17, 48, 47, 16, 15, 49, 50, 14, 13, 51, 52, 12, 11, 53, 54, 10, 9, 55, 56, 8, 7, 57, 58, 6, 5, 59, 60, 4, 3, 61, 62, 2, 1, 63, 64, 64, 65, 65, 66, 68, 69, 67, 68, 72, 73, 69, 70, 122, 121, 71, 72, 120, 119, 73, 74, 118, 117, 75, 76, 116, 115, 77, 78, 114, 113, 79, 80, 112, 111, 81, 82, 110, 109, 83, 84, 108, 107, 85, 86, 106, 105, 88, 87, 104, 103, 90, 89, 102, 101, 92, 91, 100, 99, 94, 93, 98, 97, 96, 95},
//     {262, 261, 263, 264, 260, 259, 265, 266, 258, 257, 267, 268, 256, 255, 269, 270, 254, 253, 271, 272, 252, 251, 273, 274, 250, 249, 275, 276, 248, 247, 278, 277, 246, 245, 279, 280, 244, 243, 281, 282, 242, 241, 283, 284, 240, 239, 285, 286, 238, 237, 287, 288, 52, 53, 289, 290, 56, 57, 291, 292, 60, 61, 293, 294, 358, 357, 295, 296, 356, 355, 297, 298, 354, 353, 299, 300, 352, 351, 301, 302, 350, 349, 303, 304, 348, 347, 305, 306, 346, 345, 307, 308, 344, 343, 309, 310, 342, 341, 311, 312, 340, 339, 313, 314, 338, 337, 315, 316, 336, 335, 318, 317, 334, 333, 320, 319, 332, 331, 322, 321, 330, 329, 324, 323, 328, 327, 326, 325},
//     {147, 146, 148, 149, 145, 144, 150, 151, 143, 142, 152, 153, 141, 140, 154, 155, 139, 138, 156, 157, 137, 136, 158, 159, 135, 134, 160, 161, 133, 132, 163, 162, 131, 130, 164, 165, 129, 128, 166, 167, 127, 126, 168, 169, 125, 124, 170, 171, 123, 49, 172, 173, 52, 53, 174, 175, 56, 57, 176, 177, 60, 61, 178, 179, 64, 65, 180, 181, 68, 69, 182, 183, 72, 73, 184, 185, 76, 236, 186, 187, 235, 234, 188, 189, 233, 232, 190, 191, 231, 230, 192, 193, 229, 228, 194, 195, 227, 226, 196, 197, 225, 224, 198, 199, 223, 222, 200, 201, 221, 220, 203, 202, 219, 218, 205, 204, 217, 216, 207, 206, 215, 214, 209, 208, 213, 212, 211, 210}
// };
// int to_eta[12] = {3, 3, 3, 4, 2, 4, 2, 4, 2, 1, 1, 1};

/*int to_chamber[4][24] = {
  {-3, -3, -3, -3, -3, -3, -3, -3, -3, -3, -3, -3, -3, -3, -3, -3, -3, -3, -4, -4, -4, -4, -4, -4},
  {-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -2, -2, -2, -2, -2, -2},
  {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0},
  {3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2}
};
int to_strip[24][128] = {
  {64, 68, 69, 70, 73, 74, 75, 76, 0, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 0, 87, 88, 89, 90, 93, 94, 95, 96, 0, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 0, 107, 108, 109, 110, 113, 114, 115, 116, 0, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 0, 127, 128, 0, 0, 0, 0, 1, 2, 0, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 13, 14, 15, 16, 19, 20, 21, 22, 0, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 0, 33, 34, 35, 36, 39, 40, 41, 42, 0, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 0, 53, 54, 55, 56, 59, 60, 61, 62}, {161, 157, 156, 155, 152, 151, 150, 149, 0, 148, 147, 146, 145, 144, 143, 142, 141, 140, 139, 0, 138, 137, 136, 135, 132, 131, 130, 129, 0, 256, 255, 254, 253, 252, 251, 250, 249, 248, 247, 0, 246, 245, 244, 243, 240, 239, 238, 237, 0, 236, 235, 234, 233, 232, 231, 230, 229, 228, 227, 0, 226, 225, 0, 0, 0, 0, 224, 223, 0, 222, 221, 220, 219, 218, 217, 216, 215, 214, 213, 0, 212, 211, 210, 209, 206, 205, 204, 203, 0, 202, 201, 200, 199, 198, 197, 196, 195, 194, 193, 0, 192, 191, 190, 189, 186, 185, 184, 183, 0, 182, 181, 180, 179, 178, 177, 176, 175, 174, 173, 0, 172, 171, 170, 169, 166, 165, 164, 163}, {384, 260, 261, 262, 265, 266, 267, 268, 0, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 0, 279, 280, 281, 282, 285, 286, 287, 288, 0, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 0, 299, 300, 301, 302, 305, 306, 307, 308, 0, 309, 310, 311, 312, 313, 314, 315, 316, 317, 318, 0, 319, 320, 0, 0, 0, 0, 321, 322, 0, 323, 324, 325, 326, 327, 328, 329, 330, 331, 332, 0, 333, 334, 335, 336, 339, 340, 341, 342, 0, 343, 344, 345, 346, 347, 348, 349, 350, 351, 352, 0, 353, 354, 355, 356, 359, 360, 361, 362, 0, 363, 364, 365, 366, 367, 368, 369, 370, 371, 372, 0, 373, 374, 375, 376, 379, 380, 381, 382}, {64, 68, 69, 70, 73, 74, 75, 76, 0, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 0, 87, 88, 89, 90, 93, 94, 95, 96, 0, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 0, 107, 108, 109, 110, 113, 114, 115, 116, 0, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 0, 127, 128, 0, 0, 0, 0, 1, 2, 0, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 13, 14, 15, 16, 19, 20, 21, 22, 0, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 0, 33, 34, 35, 36, 39, 40, 41, 42, 0, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 0, 53, 54, 55, 56, 59, 60, 61, 62}, {160, 164, 165, 166, 169, 170, 171, 172, 0, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 0, 183, 184, 185, 186, 189, 190, 191, 192, 0, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 0, 203, 204, 205, 206, 209, 210, 211, 212, 0, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 0, 223, 224, 0, 0, 0, 0, 225, 226, 0, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 0, 237, 238, 239, 240, 243, 244, 245, 246, 0, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 0, 129, 130, 131, 132, 135, 136, 137, 138, 0, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 0, 149, 150, 151, 152, 155, 156, 157, 158}, {384, 260, 261, 262, 265, 266, 267, 268, 0, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 0, 279, 280, 281, 282, 285, 286, 287, 288, 0, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 0, 299, 300, 301, 302, 305, 306, 307, 308, 0, 309, 310, 311, 312, 313, 314, 315, 316, 317, 318, 0, 319, 320, 0, 0, 0, 0, 321, 322, 0, 323, 324, 325, 326, 327, 328, 329, 330, 331, 332, 0, 333, 334, 335, 336, 339, 340, 341, 342, 0, 343, 344, 345, 346, 347, 348, 349, 350, 351, 352, 0, 353, 354, 355, 356, 359, 360, 361, 362, 0, 363, 364, 365, 366, 367, 368, 369, 370, 371, 372, 0, 373, 374, 375, 376, 379, 380, 381, 382}, {64, 68, 69, 70, 73, 74, 75, 76, 0, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 0, 87, 88, 89, 90, 93, 94, 95, 96, 0, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 0, 107, 108, 109, 110, 113, 114, 115, 116, 0, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 0, 127, 128, 0, 0, 0, 0, 1, 2, 0, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 13, 14, 15, 16, 19, 20, 21, 22, 0, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 0, 33, 34, 35, 36, 39, 40, 41, 42, 0, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 0, 53, 54, 55, 56, 59, 60, 61, 62}, {192, 196, 197, 198, 201, 202, 203, 204, 0, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 0, 215, 216, 217, 218, 221, 222, 223, 224, 0, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 0, 235, 236, 237, 238, 241, 242, 243, 244, 0, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 0, 255, 256, 0, 0, 0, 0, 129, 130, 0, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 0, 141, 142, 143, 144, 147, 148, 149, 150, 0, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 0, 161, 162, 163, 164, 167, 168, 169, 170, 0, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 0, 181, 182, 183, 184, 187, 188, 189, 190}, {384, 260, 261, 262, 265, 266, 267, 268, 0, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 0, 279, 280, 281, 282, 285, 286, 287, 288, 0, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 0, 299, 300, 301, 302, 305, 306, 307, 308, 0, 309, 310, 311, 312, 313, 314, 315, 316, 317, 318, 0, 319, 320, 0, 0, 0, 0, 321, 322, 0, 323, 324, 325, 326, 327, 328, 329, 330, 331, 332, 0, 333, 334, 335, 336, 339, 340, 341, 342, 0, 343, 344, 345, 346, 347, 348, 349, 350, 351, 352, 0, 353, 354, 355, 356, 359, 360, 361, 362, 0, 363, 364, 365, 366, 367, 368, 369, 370, 371, 372, 0, 373, 374, 375, 376, 379, 380, 381, 382}, {64, 68, 69, 70, 73, 74, 75, 76, 0, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 0, 87, 88, 89, 90, 93, 94, 95, 96, 0, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 0, 107, 108, 109, 110, 113, 114, 115, 116, 0, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 0, 127, 128, 0, 0, 0, 0, 1, 2, 0, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 13, 14, 15, 16, 19, 20, 21, 22, 0, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 0, 33, 34, 35, 36, 39, 40, 41, 42, 0, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 0, 53, 54, 55, 56, 59, 60, 61, 62}, {160, 164, 165, 166, 169, 170, 171, 172, 0, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 0, 183, 184, 185, 186, 189, 190, 191, 192, 0, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 0, 203, 204, 205, 206, 209, 210, 211, 212, 0, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 0, 223, 224, 0, 0, 0, 0, 225, 226, 0, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 0, 237, 238, 239, 240, 243, 244, 245, 246, 0, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 0, 129, 130, 131, 132, 135, 136, 137, 138, 0, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 0, 149, 150, 151, 152, 155, 156, 157, 158}, {384, 260, 261, 262, 265, 266, 267, 268, 0, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 0, 279, 280, 281, 282, 285, 286, 287, 288, 0, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 0, 299, 300, 301, 302, 305, 306, 307, 308, 0, 309, 310, 311, 312, 313, 314, 315, 316, 317, 318, 0, 319, 320, 0, 0, 0, 0, 321, 322, 0, 323, 324, 325, 326, 327, 328, 329, 330, 331, 332, 0, 333, 334, 335, 336, 339, 340, 341, 342, 0, 343, 344, 345, 346, 347, 348, 349, 350, 351, 352, 0, 353, 354, 355, 356, 359, 360, 361, 362, 0, 363, 364, 365, 366, 367, 368, 369, 370, 371, 372, 0, 373, 374, 375, 376, 379, 380, 381, 382}, {64, 68, 69, 70, 73, 74, 75, 76, 0, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 0, 87, 88, 89, 90, 93, 94, 95, 96, 0, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 0, 107, 108, 109, 110, 113, 114, 115, 116, 0, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 0, 127, 128, 0, 0, 0, 0, 1, 2, 0, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 13, 14, 15, 16, 19, 20, 21, 22, 0, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 0, 33, 34, 35, 36, 39, 40, 41, 42, 0, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 0, 53, 54, 55, 56, 59, 60, 61, 62}, {192, 196, 197, 198, 201, 202, 203, 204, 0, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 0, 215, 216, 217, 218, 221, 222, 223, 224, 0, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 0, 235, 236, 237, 238, 241, 242, 243, 244, 0, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 0, 255, 256, 0, 0, 0, 0, 129, 130, 0, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 0, 141, 142, 143, 144, 147, 148, 149, 150, 0, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 0, 161, 162, 163, 164, 167, 168, 169, 170, 0, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 0, 181, 182, 183, 184, 187, 188, 189, 190}, {288, 292, 293, 294, 297, 298, 299, 300, 0, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 0, 311, 312, 313, 314, 317, 318, 319, 320, 0, 321, 322, 323, 324, 325, 326, 327, 328, 329, 330, 0, 331, 332, 333, 334, 337, 338, 339, 340, 0, 341, 342, 343, 344, 345, 346, 347, 348, 349, 350, 0, 351, 352, 0, 0, 0, 0, 353, 354, 0, 355, 356, 357, 358, 359, 360, 361, 362, 363, 364, 0, 365, 366, 367, 368, 371, 372, 373, 374, 0, 375, 376, 377, 378, 379, 380, 381, 382, 383, 384, 0, 257, 258, 259, 260, 263, 264, 265, 266, 0, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 0, 277, 278, 279, 280, 283, 284, 285, 286}, {64, 68, 69, 70, 73, 74, 75, 76, 0, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 0, 87, 88, 89, 90, 93, 94, 95, 96, 0, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 0, 107, 108, 109, 110, 113, 114, 115, 116, 0, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 0, 127, 128, 0, 0, 0, 0, 1, 2, 0, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 13, 14, 15, 16, 19, 20, 21, 22, 0, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 0, 33, 34, 35, 36, 39, 40, 41, 42, 0, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 0, 53, 54, 55, 56, 59, 60, 61, 62}, {160, 164, 165, 166, 169, 170, 171, 172, 0, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 0, 183, 184, 185, 186, 189, 190, 191, 192, 0, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 0, 203, 204, 205, 206, 209, 210, 211, 212, 0, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 0, 223, 224, 0, 0, 0, 0, 225, 226, 0, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 0, 237, 238, 239, 240, 243, 244, 245, 246, 0, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 0, 129, 130, 131, 132, 135, 136, 137, 138, 0, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 0, 149, 150, 151, 152, 155, 156, 157, 158}, {288, 292, 293, 294, 297, 298, 299, 300, 0, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 0, 311, 312, 313, 314, 317, 318, 319, 320, 0, 321, 322, 323, 324, 325, 326, 327, 328, 329, 330, 0, 331, 332, 333, 334, 337, 338, 339, 340, 0, 341, 342, 343, 344, 345, 346, 347, 348, 349, 350, 0, 351, 352, 0, 0, 0, 0, 353, 354, 0, 355, 356, 357, 358, 359, 360, 361, 362, 363, 364, 0, 365, 366, 367, 368, 371, 372, 373, 374, 0, 375, 376, 377, 378, 379, 380, 381, 382, 383, 384, 0, 257, 258, 259, 260, 263, 264, 265, 266, 0, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 0, 277, 278, 279, 280, 283, 284, 285, 286}, {64, 68, 69, 70, 73, 74, 75, 76, 0, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 0, 87, 88, 89, 90, 93, 94, 95, 96, 0, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 0, 107, 108, 109, 110, 113, 114, 115, 116, 0, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 0, 127, 128, 0, 0, 0, 0, 1, 2, 0, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 0, 13, 14, 15, 16, 19, 20, 21, 22, 0, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 0, 33, 34, 35, 36, 39, 40, 41, 42, 0, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 0, 53, 54, 55, 56, 59, 60, 61, 62}, {160, 164, 165, 166, 169, 170, 171, 172, 0, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 0, 183, 184, 185, 186, 189, 190, 191, 192, 0, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 0, 203, 204, 205, 206, 209, 210, 211, 212, 0, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 0, 223, 224, 0, 0, 0, 0, 225, 226, 0, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 0, 237, 238, 239, 240, 243, 244, 245, 246, 0, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 0, 129, 130, 131, 132, 135, 136, 137, 138, 0, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 0, 149, 150, 151, 152, 155, 156, 157, 158}, {288, 292, 293, 294, 297, 298, 299, 300, 0, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 0, 311, 312, 313, 314, 317, 318, 319, 320, 0, 321, 322, 323, 324, 325, 326, 327, 328, 329, 330, 0, 331, 332, 333, 334, 337, 338, 339, 340, 0, 341, 342, 343, 344, 345, 346, 347, 348, 349, 350, 0, 351, 352, 0, 0, 0, 0, 353, 354, 0, 355, 356, 357, 358, 359, 360, 361, 362, 363, 364, 0, 365, 366, 367, 368, 371, 372, 373, 374, 0, 375, 376, 377, 378, 379, 380, 381, 382, 383, 384, 0, 257, 258, 259, 260, 263, 264, 265, 266, 0, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 0, 277, 278, 279, 280, 283, 284, 285, 286}, {25, 31, 32, 33, 36, 37, 38, 39, 0, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 0, 50, 51, 52, 53, 56, 57, 58, 59, 0, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 0, 70, 71, 72, 73, 76, 77, 78, 79, 0, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 0, 90, 91, 0, 0, 0, 0, 92, 93, 0, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 0, 104, 105, 106, 107, 110, 111, 112, 113, 0, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 0, 1, 2, 3, 4, 7, 8, 9, 0, 0, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 0, 20, 21, 22, 23, 26, 27, 0, 0}, {155, 159, 160, 161, 164, 165, 166, 167, 0, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 0, 178, 179, 180, 181, 184, 185, 186, 187, 0, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 0, 198, 199, 200, 201, 204, 205, 206, 207, 0, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 0, 218, 219, 0, 0, 0, 0, 220, 221, 0, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 0, 232, 233, 234, 235, 238, 239, 240, 241, 0, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 0, 124, 125, 126, 127, 130, 131, 132, 133, 0, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 0, 144, 145, 146, 147, 150, 151, 152, 153}, {283, 287, 288, 289, 292, 293, 294, 295, 0, 296, 297, 298, 299, 300, 301, 302, 303, 304, 305, 0, 306, 307, 308, 309, 312, 313, 314, 315, 0, 316, 317, 318, 319, 320, 321, 322, 323, 324, 325, 0, 326, 327, 328, 329, 332, 333, 334, 335, 0, 336, 337, 338, 339, 340, 341, 342, 343, 344, 345, 0, 346, 347, 0, 0, 0, 0, 0, 0, 0, 0, 0, 348, 349, 350, 351, 352, 353, 354, 355, 0, 356, 357, 358, 359, 362, 363, 364, 365, 0, 0, 366, 367, 368, 369, 370, 371, 372, 373, 374, 0, 252, 253, 254, 255, 258, 259, 260, 261, 0, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 0, 272, 273, 274, 275, 278, 279, 280, 281}
};
int to_eta[24] = {8, 8, 8, 7, 7, 7, 6, 6, 6, 5, 5, 5, 4, 4, 4, 3, 3, 3, 2, 2, 2, 1, 1, 1};*/

class GEMUnpacker
{
  public:
    GEMUnpacker(const std::string & ifilename, const std::string & isFedKit, const std::string & _ofilename) {
      try {
        m_file = std::fopen(ifilename.c_str(), "rb");
      } catch (int e) {
        std::cout << "An exception occured. Exception code " << e << std::endl;
      }
      //ofilename = ifilename.substr(0, ifilename.size()-4);
      //ofilename += ".raw.root";
      ofilename = _ofilename;
      m_isFedKit = isFedKit;
    }

    ~GEMUnpacker() {
      if (m_file != NULL) std::fclose(m_file);
    }

    void unpack(const int max_events, std::map<std::pair<int, int>, TestBeamMapping*> mappings) {

      if (max_events > 0) std::cout << "Unpacking " << max_events << " events" << std::endl;
      else std::cout << "Unpacking all events" << std::endl; 

     TFile *hfile = new TFile(ofilename.c_str(),"RECREATE","GEM Raw ROOT");
     TH2F multiplicityHisto("multiplicityHisto", ";Time from previous L1A (BX);Strips fired;", 300, 0, 300, 100, 0, 600);

     TTree outputtree("outputtree","outputtree");
     
     int nhits;
     int latency;
     int pulse_stretch;
     
     // raw hit variables
     std::vector<int> vecOH;
     std::vector<int> vecVFAT;
     std::vector<int> vecCH;
     
     // digi variables
     std::vector<int> vecDigiEta; // even for x, odd for y
     std::vector<int> vecDigiChamber; // 0 to 3 for trackers, 4 and 5 for GE21 and ME0 (not implemented yet)
     std::vector<int> vecDigiDirection; // 0 for x, 1 for y
     std::vector<int> vecDigiStrip; // 0 to 357

     // support variables
     int vfatId = 0;
     int fed = 1478; // TODO: add ME0
     int oh = 0;
     int eta = 0;
     int strip = 0;
     int chamber = 0;
     int direction = 0;

     outputtree.Branch("nhits", &nhits);
     outputtree.Branch("latency", &latency);
     outputtree.Branch("pulse_stretch", &pulse_stretch);
     outputtree.Branch("OH", &vecOH);
     outputtree.Branch("VFAT", &vecVFAT);
     outputtree.Branch("CH", &vecCH);

    // digi variable branches
     outputtree.Branch("digiEta", &vecDigiEta);
     outputtree.Branch("digiChamber", &vecDigiChamber);
     outputtree.Branch("digiDirection", &vecDigiDirection);
     outputtree.Branch("digiStrip", &vecDigiStrip);

     int n_evt=0;

     int bx, previousBx;

     while (true) {
        if ((max_events>0) && (n_evt>max_events)) break;
         if ( n_evt%1000==0 ) std::cout << "Unpacking event " << n_evt << "         \r";
         // read and print FEROL headers
         if (m_isFedKit == "ferol") {
             std::size_t sz = std::fread(&m_word, sizeof(uint64_t), 1, m_file);
             if (sz == 0 ) break;
             //printf("%016llX\n", m_word);
             std::fread(&m_word, sizeof(uint64_t), 1, m_file);
             //printf("%016llX\n", m_word);
             std::fread(&m_word, sizeof(uint64_t), 1, m_file);
             //printf("%016llX\n", m_word);
             // ferol headers read and printed, now read CDF header
             //std::fread(&m_word, sizeof(uint64_t), 1, m_file);
         } else {
             std::size_t sz = std::fread(&m_word, sizeof(uint64_t), 1, m_file);
             if (sz == 0 ) break;
             //read and print "BADC0FFEEBADCAFE" and another artificial header
          //printf("%016llX\n", m_word);
          //std::fread(&m_word, sizeof(uint64_t), 1, m_file);
          //printf("%016llX\n", m_word);
         }
         // m_AMC13Event = new AMC13Event();
         // //std::fread(&m_word, sizeof(uint64_t), 1, m_file);
         // //printf("%016llX\n", m_word);
         // m_AMC13Event->setCDFHeader(m_word);
         // std::fread(&m_word, sizeof(uint64_t), 1, m_file);
         // //printf("%016llX\n", m_word);
         // m_AMC13Event->setAMC13header(m_word);
         // //printf("%016llX\n", m_word);
         // //std::cout << "n_AMC = " << m_AMC13Event->nAMC() << std::endl;
         // // Readout out AMC headers
         // for (unsigned short i = 0; i < m_AMC13Event->nAMC(); i++){
         //     std::fread(&m_word, sizeof(uint64_t), 1, m_file);
         //     //printf("%016llX\n", m_word);
         //     m_AMC13Event->addAMCheader(m_word);
         // }

         // Readout out AMC payloads
        AMCEvent * m_amcEvent = new AMCEvent();
        nhits=0;
        vecOH.clear();
        vecVFAT.clear();
        vecCH.clear();

        vecDigiEta.clear();
        vecDigiChamber.clear();
        vecDigiDirection.clear();
        vecDigiStrip.clear();

        vfatId = 0;
        oh = 0;

         std::fread(&m_word, 8, 1, m_file);
         //printf("AMC HEADER1\n");
         //printf("%016llX\n", m_word);
         m_amcEvent->setAMCheader1(m_word);
         std::fread(&m_word, 8, 1, m_file);
         //printf("AMC HEADER2\n");
         //printf("%016llX\n", m_word);
         m_amcEvent->setAMCheader2(m_word);
         std::fread(&m_word, sizeof(uint64_t), 1, m_file);
         m_amcEvent->setGEMeventHeader(m_word);

         latency = m_amcEvent->Latency();
         pulse_stretch = m_amcEvent->PULSE_STRETCH();
         //printf("GEM EVENT HEADER\n");
         //printf("%016llX\n", m_word);
         // fill the geb data here
         //std::cout << "GDcount = " << m_amcEvent->GDcount() << std::endl;
         bx = m_amcEvent->BX();
         for (unsigned short j = 0; j < m_amcEvent->GDcount(); j++){
             GEBdata * m_gebdata = new GEBdata();
             std::fread(&m_word, sizeof(uint64_t), 1, m_file);
             m_gebdata->setChamberHeader(m_word);
             //printf("GEM CHAMBER HEADER\n");
             //printf("%016llX\n", m_word);
             // fill the vfat data here
             //std::cout << "Number of VFAT words " << m_gebdata->Vwh() << std::endl;
             //std::fread(&m_word, sizeof(uint64_t), 1, m_file);
             int m_nvb = m_gebdata->Vwh() / 3; // number of VFAT2 blocks. Eventually add here sanity check
             //printf("N vfat blocks %d\n",m_nvb);
             //printf("OH %d\n",m_gebdata->InputID());
             
             for (unsigned short k = 0; k < m_nvb; k++){
                 VFATdata * m_vfatdata = new VFATdata();
                 // read 3 vfat block words, totaly 192 bits
                 std::fread(&m_word, sizeof(uint64_t), 1, m_file);
                 //printf("VFAT WORD 1 ");
                 //std::cout << std::bitset<64>(m_word) << std::endl;
                 //printf("%016llX\n", m_word);
                 //printf("%016llX\n", m_word >> 56);
                 //printf("%016llX\n", 0x3f);
                 //printf("%016llX\n", 0x3f & (m_word >> 56));
                 m_vfatdata->read_fw(m_word);
                 std::fread(&m_word, sizeof(uint64_t), 1, m_file);
                 //printf("VFAT WORD 2 ");
                 //std::cout << std::bitset<64>(m_word) << std::endl;
                 //printf("%016llX\n", m_word);
                 m_vfatdata->read_sw(m_word);
                 std::fread(&m_word, sizeof(uint64_t), 1, m_file);
                 //printf("VFAT WORD 3 ");
                 //std::cout << std::bitset<64>(m_word) << std::endl;
                 //printf("%016llX\n", m_word);
                 m_vfatdata->read_tw(m_word);

                vfatId = m_vfatdata->Pos();
                oh = m_gebdata->InputID();

                // auto hitMapping = mappings[std::make_pair(fed, oh)];
                // eta = hitMapping->to_eta[vfatId];
                // chamber = hitMapping->to_chamber[oh][vfatId];
                /*if (oh>0) {
                  eta = mappingTracker.to_eta[vfatId];
                  chamber = mapping.to_chamber_tracker[oh][vfatId];
                } else {
                  eta = mapping.to_eta_ge21[vfatId];
                  chamber = mapping.to_chamber_ge21[oh][vfatId];
                }*/
                
                direction = eta%2;
                for (int i=0;i<64;i++) {
                  if (m_vfatdata->lsData() & (1LL << i)) {
			              vecCH.push_back(i);
                    // vecVFAT.push_back(vfatId);
                    // vecOH.push_back(oh);
                    // vecDigiEta.push_back(eta);
                    // vecDigiChamber.push_back(chamber);
                    // vecDigiDirection.push_back(direction);
                    // vecDigiStrip.push_back(hitMapping->to_strip[vfatId][i]);
                    nhits++;
                  }
                  if (m_vfatdata->msData() & (1LL << i)) {
                    vecCH.push_back(i+64);
                    // vecVFAT.push_back(vfatId);
                    // vecOH.push_back(oh);
                    // vecDigiEta.push_back(eta);
                    // vecDigiChamber.push_back(chamber);
                    // vecDigiDirection.push_back(direction);
                    // vecDigiStrip.push_back(hitMapping->to_strip[vfatId][i+64]);
                    nhits++;
                  }
                }
                delete m_vfatdata;
             }

             std::fread(&m_word, sizeof(uint64_t), 1, m_file);
             m_gebdata->setChamberTrailer(m_word);
             m_amcEvent->g_add(*m_gebdata);
             delete m_gebdata;
         }

        multiplicityHisto.Fill(bx-previousBx, nhits);
        if (nhits>500) std::cout << n_evt << " " << bx-previousBx << std::endl;

         previousBx = bx;
         std::fread(&m_word, sizeof(uint64_t), 1, m_file);
         m_amcEvent->setGEMeventTrailer(m_word);
         std::fread(&m_word, sizeof(uint64_t), 1, m_file);
         //printf("AMC TRALIER\n");
         //printf("%016llX\n", m_word);
         m_amcEvent->setAMCTrailer(m_word);

         delete m_amcEvent;

        // apply mapping and create digis
        //std::cout << nhits << std::endl;
        /*for (int nHit=0; nHit<nhits; nHit++) {
          vecDigiEta.push_back(to_eta[vecVFAT[nHit]]);
          vecDigiStrip.push_back(to_strip[vecVFAT[nHit]][vecCH[nHit]]);
        }*/

         //GEMtree.Fill();
	      //outputtree.Fill();
        n_evt++; 
        if (n_evt>1000000) break;
       //std::cout << lscount << " " <<  mscount << std::endl;
       //std::cout << std::endl;

     }

     std::cout << std::endl;
     std::cout << std::endl;

     //std::cout << std::endl;
     //std::cout << lscount << " " <<  mscount << std::endl;
     //outputtree.Write();
     multiplicityHisto.Write();
     hfile->Write();// Save file with tree
     std::cout << "Saved." << std::endl;
    }
private:
    std::FILE *m_file;
    uint64_t m_word;
    uint32_t m_word32;
    uint64_t fw_;
    uint64_t sw_;
    uint64_t tw_;
    bool type;
    AMCEvent * m_AMCEvent;
    std::string ofilename;
    std::string m_isFedKit;
};
 
int main (int argc, char** argv)
{
  std::cout << "[GEMUnpacker]: ---> Main()" << std::endl;
  if (argc<4) 
  {
    std::cout << "Please provide input filename and source type" << std::endl;
    std::cout << "Usage: <path>/unpacker ifile ferol(sdram) ofile" << std::endl;
    return 0;
  }
  std::string ifile   = argv[1];
  std::string isFedKit = argv[2];
  std::string ofile   = argv[3];
  
  int max_events = -1;
  if (argc>4) max_events = atoi(argv[4]);

  TestBeamMapping trackerMapping("mapping/tracker_mapping.csv");
  TestBeamMapping ge21Mapping("mapping/ge21_mapping.csv");

  std::cout << "Reading mapping files..." << std::endl;
  if (trackerMapping.read() < 0) {
	  std::cout << "Error reading tracker mapping" << std::endl;
	  return -1;
  }
  if (ge21Mapping.read() < 0) {
	  std::cout << "Error reading GE2/1 mapping" << std::endl;
	  return -1;
  }

  std::map<std::pair<int, int>, TestBeamMapping*> mappings = {
    {std::make_pair(1478, 0), &ge21Mapping},
    {std::make_pair(1478, 2), &trackerMapping},
    {std::make_pair(1478, 3), &trackerMapping},
  };

  /*
  std::cout << "Tracker mapping:" << std::endl;
  trackerMapping.print();

  std::cout << "GE2/1 mapping:" << std::endl;
  ge21Mapping.print();
  */

  GEMUnpacker * m_unpacker = new GEMUnpacker(ifile, isFedKit, ofile);
  m_unpacker->unpack(max_events, mappings);
  delete m_unpacker;
}
